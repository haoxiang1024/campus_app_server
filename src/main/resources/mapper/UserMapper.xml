<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.school.mapper.UserMapper">
    <insert id="register" useGeneratedKeys="true" keyProperty="user.id">
        insert into user (nickname, phone, password, photo, sex, balance, prestige, reg_date,state,role,email)
        VALUES (#{user.nickname}, #{user.phone}, #{user.password}, #{user.photo}, #{user.sex}, #{user.balance},
                #{user.prestige}, #{user.reg_date},#{user.state},#{user.role},#{user.email})
    </insert>
    <update id="resetPwd">
        update user
        set password=#{password}
        where phone = #{phone}

    </update>
    <update id="updatePhoto">
        update user
        set photo=#{photo}
        where id = #{id}
    </update>
    <update id="updateAc">
        update user
        set nickname=#{nickname},
            sex=#{sex}
        where id = #{id}
    </update>
    <update id="updateUserInfo" parameterType="com.school.entity.User">
        UPDATE user
        <set>
            <if test="nickname != null">
                nickname = #{nickname},
            </if>
            <if test="sex != null">
                sex = #{sex},
            </if>
            <if test="phone != null">
                phone = #{phone},
            </if>
            <if test="email != null">
                email = #{email},
            </if>
            <if test="photo != null">
                photo = #{photo},
            </if>
            <if test="im_token != null">
                im_token = #{im_token},
            </if>
        </set>
        WHERE id = #{id}
    </update>
    <update id="updateUserStatus">
        UPDATE user
        SET state = #{state}
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>
    <select id="findUserByPhone" resultType="java.lang.Integer">
        select id
        from user
        where phone = #{phone}
    </select>
    <select id="userInfo" resultType="com.school.entity.User">
        select *
        from user
        where id = #{id}
    </select>
    <select id="login" resultType="java.lang.String">
        select password
        from user
        where phone = #{phone}

    </select>
    <select id="getalll" resultType="com.school.entity.User">
        select * from user
    </select>
    <select id="getUserPage" resultType="com.school.entity.User">
        SELECT * FROM user
        <where>
            <if test="keyword != null and keyword != ''">
                AND (phone LIKE CONCAT('%', #{keyword}, '%') OR nickname LIKE CONCAT('%', #{keyword}, '%')OR email LIKE CONCAT('%', #{keyword}, '%'))            </if>
        </where>
        LIMIT #{offset}, #{pageSize}
    </select>

    <select id="getUserCount" resultType="int">
        SELECT COUNT(*) FROM user
        <where>
            <if test="keyword != null and keyword != ''">
                AND (phone LIKE CONCAT('%', #{keyword}, '%') OR nickname LIKE CONCAT('%', #{keyword}, '%')OR email LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
    </select>

</mapper>
