<link href="./css/sweetalert2.min.css" rel="stylesheet">
<style>
    .content-wrapper {
        background: #ffffff !important;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        padding: 25px;
        margin: 15px;
        color: #333 !important;
    }
    .text-custom-blue { color: #00aaff !important; }
    .table-light th { background-color: #f8f9fa !important; color: #666 !important; font-weight: 600; }
    .btn-outline-custom { color: #00aaff !important; border-color: #dee2e6 !important; }
    .btn-outline-custom:hover:not(:disabled) { background-color: #00aaff !important; color: white !important; }
    .btn-outline-custom:disabled { cursor: not-allowed; opacity: 0.5; }
    .detail-img-wrapper { text-align: center; padding: 15px; background: #fdfdfd; border: 1px dashed #dee2e6; border-radius: 8px; margin-top: 10px; }
    .detail-img { max-height: 250px; max-width: 100%; border-radius: 4px; cursor: zoom-in; }
    .btn-link { text-decoration: none !important; }
    .form-select-sm { border-color: #dee2e6 !important; color: #666; }
</style>

<div class="content-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-4 gap-3 flex-wrap">
        <div class="d-flex gap-2">
            <button class="btn btn-outline-success btn-sm" id="batchApproveBtn">批量通过</button>
            <button class="btn btn-outline-warning btn-sm" id="batchRejectBtn">批量驳回</button>
            <button class="btn btn-outline-danger btn-sm" id="batchDeleteBtn">批量删除</button>
            <button class="btn btn-warning btn-sm text-white px-3" onclick="openAddModal()">+ 登记信息</button>
        </div>
        <div class="d-flex gap-2">
            <select id="typeFilter" class="form-select form-select-sm" style="width: 100px;">
                <option value="">所有类型</option>
                <option value="失物">失物</option>
                <option value="招领">招领</option>
            </select>
            <select id="stateFilter" class="form-select form-select-sm" style="width: 110px;">
                <option value="">所有状态</option>
                <option value="待审核">待审核</option>
                <option value="未找到">未找到</option>
                <option value="已找到">已找到</option>
                <option value="已驳回">已驳回</option>
            </select>
            <div class="input-group input-group-sm" style="width: 250px;">
                <input type="text" id="searchInput" class="form-control" placeholder="搜索名称/地点/联系人...">
                <button class="btn btn-primary" type="button" id="searchBtn">
                    <i class="fa fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th style="width: 45px;"><input type="checkbox" id="selectAll" class="form-check-input"></th>
                <th style="width: 80px;">类型</th>
                <th>物品名称</th>
                <th>地点</th>
                <th>发布时间</th>
                <th>联系电话</th>
                <th>状态</th>
                <th class="text-center">操作</th>
            </tr>
            </thead>
            <tbody id="lostTableBody">
            <tr><td colspan="8" class="text-center text-muted">正在检索数据...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="d-flex flex-column align-items-center mt-4" id="paginationWrapper">
        <div class="d-flex align-items-center gap-3">
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLostFirstPage">首页</button>
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLostPrevPage">上一页</button>
            </div>
            <span id="lostPageInfo" class="text-custom-blue fw-bold">第 1 页 / 共 1 页</span>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLostNextPage">下一页</button>
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLostLastPage">末页</button>
            </div>
        </div>
        <div class="mt-2 text-muted small">共 <span id="lostTotalCount">0</span> 条记录</div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-custom-blue">信息详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-0" id="detailContent"></div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<script src="./js/jquery.min.js"></script>
<script src="./js/bootstrap.bundle.min.js"></script>
<script src="./js/sweetalert2@11.js"></script>

<script>
    // 统一定制 Toast 提示
    window.Toast = window.Toast || {
        success: (msg) => {
            Swal.fire({ icon: 'success', title: msg, toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, width: '220px', padding: '0.5rem' });
        },
        error: (msg) => {
            Swal.fire({ icon: 'error', title: '操作失败', text: msg, confirmButtonColor: '#00aaff', width: '320px' });
        },
        confirm: (title, text, callback) => {
            Swal.fire({ title: title, text: text, icon: 'warning', showCancelButton: true, confirmButtonColor: '#00aaff', cancelButtonColor: '#6c757d', confirmButtonText: '确定', cancelButtonText: '取消' }).then((result) => { if (result.isConfirmed) callback(); });
        },
        prompt: (title, placeholder, callback) => {
            Swal.fire({
                title: title,
                input: 'text',
                inputPlaceholder: placeholder,
                showCancelButton: true,
                confirmButtonColor: '#00aaff',
                confirmButtonText: '提交',
                cancelButtonText: '取消',
                inputValidator: (value) => { if (!value) return '请务必填写原因！' }
            }).then((result) => { if (result.isConfirmed) callback(result.value); });
        }
    };

    (function() {
        let currentLostPage = 1;
        let totalLostPages = 1;
        const pageSize = 10;
        let allLostData = []; // 当前页数据缓存

        function formatDate(ts) {
            if (!ts) return '未设置';
            const d = new Date(ts);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        // 加载数据
        function loadLostData(page) {
            currentLostPage = page;
            const keyword = $('#searchInput').val().trim();
            const state = $('#stateFilter').val();
            const type = $('#typeFilter').val();

            $('#lostTableBody').html('<tr><td colspan="8" class="text-center text-muted">正在检索最新数据...</td></tr>');

            $.get('/school/admin/getLostList', {
                page: page,
                pageSize: pageSize,
                keyword: keyword,
                state: state,
                type: type
            }, function(res) {
                if(res.status === 0 && res.data) {
                    allLostData = res.data.list || [];
                    const totalItems = res.data.total || 0;
                    totalLostPages = res.data.totalPages || 1;

                    renderLostTable(allLostData);

                    $('#lostPageInfo').text(`第 ${currentLostPage} 页 / 共 ${totalLostPages} 页`);
                    $('#lostTotalCount').text(totalItems);
                    $('#btnLostFirstPage, #btnLostPrevPage').prop('disabled', currentLostPage <= 1);
                    $('#btnLostNextPage, #btnLostLastPage').prop('disabled', currentLostPage >= totalLostPages);
                    $('#selectAll').prop('checked', false);
                } else {
                    $('#lostTableBody').html('<tr><td colspan="8" class="text-center text-danger">数据加载失败</td></tr>');
                }
            });
        }

        // 渲染表格
        function renderLostTable(data) {
            let html = '';
            if (!data.length) {
                html = '<tr><td colspan="8" class="text-center text-muted">未找到匹配的记录</td></tr>';
            } else {
                data.forEach(item => {
                    let typeBadge = item.type === '招领'
                        ? '<span class="badge border text-success border-success">招领</span>'
                        : '<span class="badge border text-danger border-danger">失物</span>';

                    let badgeClass = 'bg-secondary';
                    if(item.state === '待审核') badgeClass = 'bg-info';
                    else if(item.state === '未找到') badgeClass = 'bg-primary';
                    else if(item.state === '已找到') badgeClass = 'bg-success';
                    else if(item.state === '已驳回') badgeClass = 'bg-danger';

                    let btns = `<button class="btn btn-sm btn-link text-custom-blue p-0 me-2" onclick="showLostDetail(${item.id})">详情</button>`;
                    if(item.state === '待审核') {
                        btns += `<button class="btn btn-sm btn-link text-success p-0 me-2 fw-bold" onclick="approveSingle(${item.id})">通过</button>`;
                        btns += `<button class="btn btn-sm btn-link text-warning p-0 me-2 fw-bold" onclick="rejectSingle(${item.id})">驳回</button>`;
                    }
                    btns += `<button class="btn btn-sm btn-link text-danger p-0" onclick="deleteLostItem(${item.id})">删除</button>`;

                    html += `<tr>
                        <td><input type="checkbox" class="item-checkbox form-check-input" value="${item.id}"></td>
                        <td>${typeBadge}</td>
                        <td class="fw-bold">${item.title}</td>
                        <td>${item.place}</td>
                        <td><small class="text-muted">${formatDate(item.pubDate)}</small></td>
                        <td>${item.phone || '-'}</td>
                        <td><span class="badge ${badgeClass} text-white">${item.state}</span></td>
                        <td class="text-center">${btns}</td>
                    </tr>`;
                });
            }
            $('#lostTableBody').html(html);
        }

        // --- 批量操作逻辑  ---

        $('#batchApproveBtn').on('click', function() {
            const selectedIds = $('.item-checkbox:checked').map(function() { return $(this).val(); }).get();
            if (!selectedIds.length) return window.Toast.error('请先勾选项目');

            const targetIds = [];
            let skipCount = 0;
            selectedIds.forEach(id => {
                const item = allLostData.find(u => u.id == id);
                if (item && item.state === '待审核') targetIds.push(id);
                else skipCount++;
            });

            if (!targetIds.length) return window.Toast.error('选中项中没有需要审核的记录');

            const msg = skipCount > 0
                ? `确认通过选中的 ${targetIds.length} 项记录吗？(已跳过 ${skipCount} 项非待审核记录)`
                : `确认通过选中的 ${targetIds.length} 项待审核记录吗？`;

            window.Toast.confirm('批量通过', msg, () => {
                $.post('/school/admin/batchUpdateStatus', { ids: targetIds.join(','), state: '未找到' }, (res) => {
                    if(res.status === 0) { window.Toast.success("批量审核通过"); loadLostData(currentLostPage); }
                });
            });
        });

        $('#batchRejectBtn').on('click', function() {
            const selectedIds = $('.item-checkbox:checked').map(function() { return $(this).val(); }).get();
            if (!selectedIds.length) return window.Toast.error('请先勾选项目');

            const targetIds = [];
            let skipCount = 0;
            selectedIds.forEach(id => {
                const item = allLostData.find(u => u.id == id);
                if (item && item.state === '待审核') targetIds.push(id);
                else skipCount++;
            });

            if (!targetIds.length) return window.Toast.error('只有待审核的记录可以执行驳回');

            const title = skipCount > 0 ? `批量驳回 (跳过 ${skipCount} 项)` : '批量驳回';
            window.Toast.prompt(title, '请输入统一驳回原因', (reason) => {
                $.post('/school/admin/batchUpdateStatus', { ids: targetIds.join(','), state: '已驳回', reason: reason }, (res) => {
                    if(res.status === 0) { window.Toast.success("操作成功"); loadLostData(currentLostPage); }
                });
            });
        });

        $('#batchDeleteBtn').on('click', function() {
            const ids = $('.item-checkbox:checked').map(function() { return $(this).val(); }).get();
            if (!ids.length) return window.Toast.error('请选择项目');
            window.Toast.confirm("批量删除", `确定永久删除选中的 ${ids.length} 项记录吗？`, () => {
                $.post('/school/admin/batchDeleteLost', { ids: ids.join(',') }, (res) => {
                    if(res.status === 0) { window.Toast.success("删除成功"); loadLostData(1); }
                });
            });
        });

        // --- 单项操作逻辑 ---

        window.approveSingle = (id) => {
            window.Toast.confirm('审核通过', '确认发布该信息吗？', () => {
                $.post('/school/admin/updateLostStatus', { lostId: id, state: '未找到' }, (res) => {
                    if(res.status === 0) { window.Toast.success("已发布"); loadLostData(currentLostPage); }
                });
            });
        };

        window.rejectSingle = (id) => {
            window.Toast.prompt('审核驳回', '说明驳回理由', (reason) => {
                $.post('/school/admin/updateLostStatus', { lostId: id, state: '已驳回', reason: reason }, (res) => {
                    if(res.status === 0) { window.Toast.success("已驳回"); loadLostData(currentLostPage); }
                });
            });
        };

        window.showLostDetail = (id) => {
            $.get('/school/admin/getLostById', { lostId: id, _t: new Date().getTime() }, function(res) {
                if(res.status === 0 && res.data) {
                    const item = res.data;
                    const typeLabel = item.type === '招领' ? '【招领】' : '【失物】';
                    const content = `
                        <div class="mb-2"><strong>类型：</strong>${typeLabel}</div>
                        <div class="mb-2"><strong>标题：</strong>${item.title}</div>
                        <div class="mb-2"><strong>地点：</strong>${item.place}</div>
                        <div class="mb-3"><strong>详情：</strong>${item.content || '无'}</div>
                        <div class="detail-img-wrapper">
                            <img src="${item.img || './images/no-image.png'}" class="detail-img" onclick="window.open(this.src)">
                        </div>`;
                    $('#detailContent').html(content);
                    new bootstrap.Modal('#detailModal').show();
                }
            });
        };

        window.deleteLostItem = (id) => {
            window.Toast.confirm("删除确认", "确定永久删除此信息吗？", () => {
                $.post('/school/admin/deleteLost', { lostId: id }, (res) => {
                    if(res.status === 0) { window.Toast.success("已删除"); loadLostData(currentLostPage); }
                });
            });
        };

        // --- 事件监听 ---

        $('#searchBtn').on('click', () => loadLostData(1));
        $('#searchInput').on('keypress', e => { if(e.which === 13) loadLostData(1); });
        $('#stateFilter, #typeFilter').on('change', () => loadLostData(1));
        $('#selectAll').on('change', function() { $('.item-checkbox').prop('checked', this.checked); });

        $('#btnLostFirstPage').on('click', () => loadLostData(1));
        $('#btnLostLastPage').on('click', () => loadLostData(totalLostPages));
        $('#btnLostPrevPage').on('click', () => { if(currentLostPage > 1) loadLostData(currentLostPage - 1); });
        $('#btnLostNextPage').on('click', () => { if(currentLostPage < totalLostPages) loadLostData(currentLostPage + 1); });

        // 首次加载
        loadLostData(1);
    })();
</script>