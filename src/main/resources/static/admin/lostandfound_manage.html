<link href="./css/sweetalert2.min.css" rel="stylesheet">
<style>
    /* 自定义开关颜色 */
    .form-check-input.stick-switch:checked {
        background-color: #00aaff;
        border-color: #00aaff;
    }
    .content-wrapper {
        background: #ffffff !important;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        padding: 25px;
        margin: 15px;
        color: #333 !important;
    }
    .text-custom-blue { color: #00aaff !important; }
    .table-light th { background-color: #f8f9fa !important; color: #666 !important; font-weight: 600; }
    .btn-outline-custom { color: #00aaff !important; border-color: #dee2e6 !important; }
    .btn-outline-custom:hover:not(:disabled) { background-color: #00aaff !important; color: white !important; }
    .btn-outline-custom:disabled { cursor: not-allowed; opacity: 0.5; }
    .detail-img-wrapper { text-align: center; padding: 15px; background: #fdfdfd; border: 1px dashed #dee2e6; border-radius: 8px; margin-top: 10px; }
    .detail-img { max-height: 250px; max-width: 100%; border-radius: 4px; cursor: zoom-in; }
    .btn-link { text-decoration: none !important; }
    .form-select-sm { border-color: #dee2e6 !important; color: #666; }
</style>

<div class="content-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-4 gap-3 flex-wrap ">
        <div class="d-flex gap-2">
            <button class="btn btn-outline-success btn-sm" id="batchApproveBtn">通过</button>
            <button class="btn btn-outline-warning btn-sm" id="batchRejectBtn">驳回</button>
            <button class="btn btn-outline-danger btn-sm" id="batchDeleteBtn">删除</button>
            <button class="btn btn-outline-primary btn-sm" id="batchStickBtn">置顶</button>
            <button class="btn btn-outline-info btn-sm" id="batchCancleStickBtn">取消置顶</button>
            <button class="btn btn-warning btn-sm text-white px-3" onclick="openAddModal()">+ 登记</button>
        </div>
        <div class="d-flex gap-2">
            <select id="typeFilter" class="form-select form-select-sm" style="width: 100px;">
                <option value="">所有类型</option>
                <option value="失物">失物</option>
                <option value="招领">招领</option>
            </select>
            <select id="stateFilter" class="form-select form-select-sm" style="width: 100px;">
                <option value="">所有状态</option>
                <option value="待审核">待审核</option>
                <option value="寻找中">寻找中</option>
                <option value="已找到">已找到</option>
                <option value="待认领">待认领</option>
                <option value="已认领">已认领</option>
                <option value="已驳回">已驳回</option>
            </select>
            <div class="input-group input-group-sm" style="width: 220px;">
                <input type="text" id="searchInput" class="form-control" placeholder="搜索标题/地点/联系电话...">
                <button class="btn btn-primary" type="button" id="searchBtn">
                    <i class="fa fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th style="width: 45px;"><input type="checkbox" id="selectAll" class="form-check-input"></th>
                <th style="width: 80px;">类型</th>
                <th>置顶</th>
                <th>标题</th>
                <th>地点</th>
                <th>发布时间</th>
                <th>联系电话</th>
                <th>状态</th>
                <th class="text-center">操作</th>
            </tr>
            </thead>
            <tbody id="lostTableBody">
            <tr><td colspan="8" class="text-center text-muted">正在检索数据...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="d-flex flex-column align-items-center mt-4" id="paginationWrapper">
        <div class="d-flex align-items-center gap-3">
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLostFirstPage">首页</button>
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLostPrevPage">上一页</button>
            </div>
            <span id="lostPageInfo" class="text-custom-blue fw-bold">第 1 页 / 共 1 页</span>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLostNextPage">下一页</button>
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLostLastPage">末页</button>
            </div>
        </div>
        <div class="mt-2 text-muted small">共 <span id="lostTotalCount">0</span> 条记录</div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-custom-blue">信息详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-0" id="detailContent"></div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-custom-blue">信息登记</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">发布类型</label>
                            <select class="form-select" name="op" id="addOp" required>
                                <option value="失物">失物登记</option>
                                <option value="招领">招领登记</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">物品名称</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">是否置顶</label>
                            <select class="form-select" name="isTop" id="addIsTop">
                                <option value="0">否</option>
                                <option value="1">是</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">所属分类</label>
                            <select class="form-select" name="categoryId" id="addCategory" required>
                                <option value="1">数码设备</option>
                                <option value="2">证件</option>
                                <option value="3">日用品</option>
                                <option value="4">服饰</option>
                                <option value="5">其他</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">地点</label>
                            <input type="text" class="form-control" name="place" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">联系电话</label>
                            <input type="text" class="form-control" name="phone" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">发生时间</label>
                            <input type="datetime-local" class="form-control" name="happenedTime" id="addTime" step="1" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">详细描述</label>
                            <textarea class="form-control" name="content" rows="3"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">上传图片</label>
                            <input type="file" class="form-control" name="upload_file" id="upload_file" accept="image/*" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitRegistration()">立即发布</button>
            </div>
        </div>
    </div>
</div>
<script src="./js/jquery.min.js"></script>
<script src="./js/bootstrap.bundle.min.js"></script>
<script src="./js/sweetalert2@11.js"></script>

<script>
    // 统一定制 Toast 提示 - 修复参数传递逻辑，增加异常处理
    window.Toast = window.Toast || {
        success: (msg) => {
            Swal.fire({
                icon: 'success',
                title: msg,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                width: '220px',
                padding: '0.5rem'
            });
        },
        error: (msg) => {
            Swal.fire({
                icon: 'error',
                title: '操作失败',
                text: msg || '未知错误',
                confirmButtonColor: '#00aaff',
                width: '320px'
            });
        },
        confirm: (title, text, callback) => {
            Swal.fire({
                title: title,
                text: text,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#00aaff',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '确定',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed && typeof callback === 'function') {
                    callback();
                }
            });
        },
        // 修复prompt方法：优化参数默认值，增加类型校验
        prompt: (title, placeholder, callback) => {
            // 确保参数有默认值，避免undefined
            const promptTitle = title || '请输入信息';
            const promptPlaceholder = placeholder || '请输入...';

            Swal.fire({
                title: promptTitle,
                input: 'text',
                inputPlaceholder: promptPlaceholder,
                showCancelButton: true,
                confirmButtonColor: '#00aaff',
                confirmButtonText: '提交',
                cancelButtonText: '取消',
                inputValidator: (value) => {
                    if (!value) return '请务必填写原因！';
                }
            }).then((result) => {
                if (result.isConfirmed && typeof callback === 'function') {
                    callback(result.value);
                }
            });
        }
    };

    (function() {
        let currentLostPage = 1;
        let totalLostPages = 1;
        const pageSize = 10;
        let allData = []; // 当前页数据缓存

        // 获取图片URL - 增加空值校验
        function getPhotoUrl(photo) {
            if (!photo || photo.trim() === '') return './svgs/solid/circle-user.svg';
            if (photo.startsWith('http')) return photo;
            return '/school/upload/' + photo;
        }

        // 格式化日期 - 增加时间戳有效性校验
        function formatDate(ts) {
            if (!ts || isNaN(ts)) return '未设置';
            const d = new Date(Number(ts));
            // 校验日期是否有效
            if (d.toString() === 'Invalid Date') return '未设置';
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        // 加载数据 - 增加错误处理
        function loadData(page) {
            currentLostPage = page || 1;
            const keyword = $('#searchInput').val().trim();
            const state = $('#stateFilter').val();
            const type = $('#typeFilter').val();

            $('#lostTableBody').html('<tr><td colspan="8" class="text-center text-muted">正在检索最新数据...</td></tr>');

            $.get('/school/admin/getLostFoundByPage', {
                page: currentLostPage,
                pageSize: pageSize,
                keyword: keyword,
                state: state,
                type: type
            }, function(res) {
                if(res && res.status === 0 && res.data) {
                    allData = res.data.list || [];
                    const totalItems = res.data.total || 0;
                    totalLostPages = res.data.totalPages || 1;

                    renderLostTable(allData);

                    $('#lostPageInfo').text(`第 ${currentLostPage} 页 / 共 ${totalLostPages} 页`);
                    $('#lostTotalCount').text(totalItems);
                    $('#btnLostFirstPage, #btnLostPrevPage').prop('disabled', currentLostPage <= 1);
                    $('#btnLostNextPage, #btnLostLastPage').prop('disabled', currentLostPage >= totalLostPages);
                    $('#selectAll').prop('checked', false);
                } else {
                    $('#lostTableBody').html('<tr><td colspan="8" class="text-center text-danger">数据加载失败：' + (res?.msg || '接口返回异常') + '</td></tr>');
                }
            }).fail(function(xhr, status, error) {
                // 增加AJAX请求失败的处理
                $('#lostTableBody').html('<tr><td colspan="8" class="text-center text-danger">数据加载失败：网络异常</td></tr>');
                console.error('加载数据失败：', error);
            });
        }

        // 渲染表格 - 优化DOM操作，增加数据校验
        function renderLostTable(data) {
            let html = '';
            if (!data || !data.length) {
                html = '<tr><td colspan="8" class="text-center text-muted">未找到匹配的记录</td></tr>';
            } else {
                data.forEach(item => {
                    // 确保item有值，避免undefined报错
                    item = item || {};
                    let typeBadge = item.type === '招领'
                        ? '<span class="badge border text-success border-success">招领</span>'
                        : '<span class="badge border text-danger border-danger">失物</span>';

                    let badgeClass = 'bg-secondary';
                    if(item.state === '待审核') badgeClass = 'bg-info';
                    else if(item.state === '寻找中') badgeClass = 'bg-primary';
                    else if(item.state === '已认领') badgeClass = 'bg-success';
                    else if(item.state === '已驳回') badgeClass = 'bg-danger';

                    let btns = `<button class="btn btn-sm btn-link text-custom-blue p-0 me-2" onclick="showLostDetail(${item.id || 0})">详情</button>`;
                    if(item.state === '待审核') {
                        btns += `<button class="btn btn-sm btn-link text-success p-0 me-2 fw-bold" onclick="approveSingle(${item.id || 0})">通过</button>`;
                        btns += `<button class="btn btn-sm btn-link text-warning p-0 me-2 fw-bold" onclick="rejectSingle(${item.id || 0})">驳回</button>`;
                    }
                    btns += `<button class="btn btn-sm btn-link text-danger p-0" onclick="deleteItem(${item.id || 0})">删除</button>`;

                    html += `<tr>
                        <td><input type="checkbox" class="item-checkbox form-check-input" value="${item.id || 0}"></td>
                        <td>${typeBadge}</td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input stick-switch"
                                       type="checkbox"
                                       data-id="${item.id || 0}"
                                       ${item.stick == 1 ? 'checked' : ''}>
                            </div>
                        </td>
                        <td class="fw-bold">${item.title || '未命名'}</td>
                        <td>${item.place || '-'}</td>
                        <td><small class="text-muted">${formatDate(item.pubDate)}</small></td>
                        <td>${item.phone || '-'}</td>
                        <td><span class="badge ${badgeClass} text-white">${item.state || '未知'}</span></td>
                        <td class="text-center">${btns}</td>
                    </tr>`;
                });
            }
            $('#lostTableBody').html(html);

            // 绑定置顶开关事件 - 增加防抖和异常处理
            $('.stick-switch').off('change').on('change', function() {
                const $this = $(this);
                // 防止重复触发
                if ($this.data('processing')) return;
                $this.data('processing', true);

                const id = $this.data('id');
                const isChecked = this.checked ? 1 : 0;

                updateStickStatus(id, isChecked).finally(() => {
                    $this.data('processing', false);
                });
            });
        }

        // 更新置顶状态 - 改为返回Promise，增加异常处理
        function updateStickStatus(id, stick) {
            return $.post('/school/admin/updateStickStatus', { id: id, stick: stick })
                .done(function(res) {
                    if (res && res.status === 0) {
                        window.Toast.success(stick === 1 ? '已置顶' : '取消置顶');
                    } else {
                        window.Toast.error(res?.msg || '操作失败');
                        // 回滚开关状态
                        $(`.stick-switch[data-id="${id}"]`).prop('checked', stick === 1 ? false : true);
                        loadData(currentLostPage);
                    }
                })
                .fail(function() {
                    window.Toast.error('网络异常，操作失败');
                    $(`.stick-switch[data-id="${id}"]`).prop('checked', stick === 1 ? false : true);
                    loadData(currentLostPage);
                });
        }

        // 批量通过
        $('#batchApproveBtn').on('click', function() {
            const selectedIds = $('.item-checkbox:checked').map(function() {
                return $(this).val();
            }).get().filter(id => id); // 过滤空值

            if (!selectedIds.length) return window.Toast.error('请先勾选项目');

            const targetItems = allData.filter(item =>
                selectedIds.includes(item.id.toString()) && item.state === '待审核'
            );

            if (targetItems.length === 0) {
                return window.Toast.error('选中的记录中没有待审核的项');
            }

            window.Toast.confirm('批量通过', `确定要审核通过这 ${targetItems.length} 条记录吗？`, () => {
                const promises = targetItems.map(item => {
                    const targetState = (item.type === '失物') ? '寻找中' : '待认领';
                    return $.post('/school/admin/updateLostFoundStatus', {
                        lostFoundId: item.id,
                        state: targetState
                    });
                });

                Promise.allSettled(promises).then(results => { // 改用allSettled，避免一个失败全部失败
                    const successCount = results.filter(res => res.status === 'fulfilled' && res.value?.status === 0).length;

                    if (successCount === targetItems.length) {
                        window.Toast.success(`批量操作成功，共处理 ${successCount} 条记录`);
                    } else {
                        window.Toast.success(`操作完成：${successCount} 条成功，${targetItems.length - successCount} 条失败`);
                    }
                    loadData(currentLostPage);
                }).catch(err => {
                    window.Toast.error("网络异常，批量请求未能全部完成");
                    console.error(err);
                });
            });
        });

        // 批量驳回
        $('#batchRejectBtn').on('click', function() {
            const selectedIds = $('.item-checkbox:checked').map(function() {
                return $(this).val();
            }).get().filter(id => id);

            if (!selectedIds.length) return window.Toast.error('请先勾选项目');

            const targetIds = [];
            let skipCount = 0;
            selectedIds.forEach(id => {
                const item = allData.find(u => u.id == id);
                if (item && item.state === '待审核') {
                    targetIds.push(id);
                } else {
                    skipCount++;
                }
            });

            if (!targetIds.length) return window.Toast.error('选中项中没有符合驳回条件（待审核）的记录');

            const title = skipCount > 0 ? `批量驳回 (将跳过 ${skipCount} 项)` : '批量驳回';
            window.Toast.prompt(title, '请输入统一的驳回原因', (reason) => {
                const promises = targetIds.map(id => {
                    return $.post('/school/admin/updateLostFoundStatus', {
                        lostFoundId: id,
                        state: '已驳回',
                        reason: reason
                    });
                });

                Promise.allSettled(promises).then(results => {
                    const successCount = results.filter(res => res.status === 'fulfilled' && res.value?.status === 0).length;
                    window.Toast.success(`操作完成：成功驳回 ${successCount} 条记录`);
                    loadData(currentLostPage);
                }).catch(err => {
                    window.Toast.error("部分请求失败，请检查网络");
                    loadData(currentLostPage);
                });
            });
        });

        // 批量删除
        $('#batchDeleteBtn').on('click', function() {
            const selectedIds = $('.item-checkbox:checked').map(function() {
                return $(this).val();
            }).get().filter(id => id);

            if (!selectedIds.length) return window.Toast.error('请勾选要删除的项目');

            window.Toast.confirm("批量删除", `确定永久删除选中的 ${selectedIds.length} 项记录吗？`, () => {
                const promises = selectedIds.map(id => {
                    return $.post('/school/admin/deleteLostFoundById', { lostFoundId: id });
                });

                Promise.allSettled(promises).then(() => {
                    window.Toast.success("删除操作完成");
                    loadData(1);
                }).catch(err => {
                    window.Toast.error("部分请求失败");
                    loadData(currentLostPage);
                });
            });
        });

        // 批量置顶
        $('#batchStickBtn').on('click', function() {
            const targetIds = [];
            let skipCount = 0;

            $('.item-checkbox:checked').each(function() {
                const $row = $(this).closest('tr');
                const $stickSwitch = $row.find('.stick-switch');
                const id = $(this).val();

                if (id && !$stickSwitch.prop('checked')) {
                    targetIds.push(id);
                } else {
                    skipCount++;
                }
            });

            if (targetIds.length === 0) {
                if (skipCount > 0) {
                    return window.Toast.error('选中的项目已全部处于置顶状态');
                } else {
                    return window.Toast.error('请先勾选项目');
                }
            }

            const confirmMsg = skipCount > 0
                ? `确定要置顶选中的 ${targetIds.length} 条记录吗？(已自动跳过 ${skipCount} 条已置顶记录)`
                : `确定要置顶选中的 ${targetIds.length} 条记录吗？`;

            window.Toast.confirm('批量置顶', confirmMsg, () => {
                const promises = targetIds.map(id => {
                    return $.post('/school/admin/updateStickStatus', {
                        id: id,
                        stick: 1
                    });
                });

                Promise.allSettled(promises).then(results => {
                    const successCount = results.filter(res => res.status === 'fulfilled' && res.value?.status === 0).length;
                    window.Toast.success(`操作完成：${successCount} 条成功`);
                    loadData(currentLostPage);
                }).catch(err => {
                    window.Toast.error("部分请求失败");
                    loadData(currentLostPage);
                });
            });
        });

        // 批量取消置顶
        $('#batchCancleStickBtn').on('click', function() {
            const targetIds = [];
            let skipCount = 0;

            $('.item-checkbox:checked').each(function() {
                const $row = $(this).closest('tr');
                const $stickSwitch = $row.find('.stick-switch');
                const id = $(this).val();

                if (id && $stickSwitch.prop('checked')) {
                    targetIds.push(id);
                } else {
                    skipCount++;
                }
            });

            if (targetIds.length === 0) {
                if (skipCount > 0) {
                    return window.Toast.error('选中的项目本就未置顶，无需取消');
                } else {
                    return window.Toast.error('请先勾选项目');
                }
            }

            const confirmMsg = skipCount > 0
                ? `确定要取消选中的 ${targetIds.length} 条记录的置顶吗？(已跳过 ${skipCount} 条本就未置顶记录)`
                : `确定要取消选中的 ${targetIds.length} 条记录的置顶吗？`;

            window.Toast.confirm('取消置顶', confirmMsg, () => {
                const promises = targetIds.map(id => {
                    return $.post('/school/admin/updateStickStatus', {
                        id: id,
                        stick: 0
                    });
                });

                Promise.allSettled(promises).then(results => {
                    const successCount = results.filter(res => res.status === 'fulfilled' && res.value?.status === 0).length;
                    window.Toast.success(`操作完成：成功取消 ${successCount} 条置顶`);
                    loadData(currentLostPage);
                }).catch(err => {
                    window.Toast.error("部分请求失败");
                    loadData(currentLostPage);
                });
            });
        });

        // 单个通过
        window.approveSingle = (id) => {
            if (!id) return window.Toast.error('无效的记录ID');

            const item = allData.find(u => u.id == id);
            if (!item) return window.Toast.error('记录不存在');

            const targetState = item.type === '失物' ? '寻找中' : '待认领';

            window.Toast.confirm('审核通过', `确认将该${item.type}信息发布为“${targetState}”吗？`, () => {
                $.post('/school/admin/updateLostFoundStatus', {
                    lostFoundId: id,
                    state: targetState
                }, (res) => {
                    if(res && res.status === 0) {
                        window.Toast.success("已发布");
                        loadData(currentLostPage);
                    } else {
                        window.Toast.error(res?.msg || '操作失败');
                    }
                }).fail(() => {
                    window.Toast.error('网络异常，操作失败');
                });
            });
        };

        // 单个驳回 - 修复核心问题：确保prompt函数调用正常
        window.rejectSingle = (id) => {
            if (!id) return window.Toast.error('无效的记录ID');

            // 确认window.Toast.prompt存在且是函数
            if (typeof window.Toast.prompt !== 'function') {
                return window.Toast.error('提示组件初始化失败，请刷新页面');
            }

            window.Toast.prompt('审核驳回', '请输入驳回理由', (reason) => {
                $.post('/school/admin/updateLostFoundStatus', {
                    lostFoundId: id,
                    state: '已驳回',
                    reason: reason
                }, (res) => {
                    if(res && res.status === 0) {
                        window.Toast.success("已驳回");
                        loadData(currentLostPage);
                    } else {
                        window.Toast.error(res?.msg || '操作失败');
                    }
                }).fail(() => {
                    window.Toast.error('网络异常，操作失败');
                });
            });
        };

        // 查看详情
        window.showLostDetail = (id) => {
            if (!id) return window.Toast.error('无效的记录ID');

            $.get('/school/admin/getLostFoundById', {
                lostFoundId: id,
                _t: new Date().getTime()
            }, function(res) {
                if(res && res.status === 0 && res.data) {
                    const item = res.data;
                    const typeLabel = item.type === '招领' ? '招领' : '失物';
                    const content = `
                        <div class="mb-2"><strong>类型：</strong>${typeLabel}</div>
                        <div class="mb-2"><strong>标题：</strong>${item.title || '未命名'}</div>
                        <div class="mb-2"><strong>地点：</strong>${item.place || '-'}</div>
                        <div class="mb-3"><strong>详情：</strong>${item.content || '无'}</div>
                        <div class="detail-img-wrapper">
                            <img src="${getPhotoUrl(item.img)}" class="detail-img" onclick="window.open(this.src)">
                        </div>`;
                    $('#detailContent').html(content);
                    new bootstrap.Modal('#detailModal').show();
                } else {
                    window.Toast.error('获取详情失败');
                }
            }).fail(() => {
                window.Toast.error('网络异常，无法获取详情');
            });
        };

        // 删除单个
        window.deleteItem = (id) => {
            if (!id) return window.Toast.error('无效的记录ID');

            window.Toast.confirm("删除确认", "确定永久删除此信息吗？", () => {
                $.post('/school/admin/deleteLostFoundById', { lostFoundId: id }, (res) => {
                    if(res && res.status === 0) {
                        window.Toast.success("已删除");
                        loadData(currentLostPage);
                    } else {
                        window.Toast.error(res?.msg || '删除失败');
                    }
                }).fail(() => {
                    window.Toast.error('网络异常，删除失败');
                });
            });
        };

        // 事件监听
        $('#searchBtn').on('click', () => loadData(1));
        $('#searchInput').on('keypress', e => { if(e.which === 13) loadData(1); });
        $('#stateFilter, #typeFilter').on('change', () => loadData(1));
        $('#selectAll').on('change', function() { $('.item-checkbox').prop('checked', this.checked); });

        $('#btnLostFirstPage').on('click', () => loadData(1));
        $('#btnLostLastPage').on('click', () => loadData(totalLostPages));
        $('#btnLostPrevPage').on('click', () => { if(currentLostPage > 1) loadData(currentLostPage - 1); });
        $('#btnLostNextPage').on('click', () => { if(currentLostPage < totalLostPages) loadData(currentLostPage + 1); });

        // 首次加载
        loadData(1);

        // 打开登记弹窗
        window.openAddModal = () => {
            $('#addForm')[0].reset();
            // 设置默认时间为当前
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            $('#addTime').val(now.toISOString().slice(0, 16));
            new bootstrap.Modal('#addModal').show();
        };

        // 提交登记信息 - 增加表单校验和异常处理
        window.submitRegistration = () => {
            const addForm = $('#addForm')[0];
            // HTML5表单校验
            if (!addForm.checkValidity()) {
                addForm.reportValidity();
                return;
            }

            const op = $('#addOp').val();
            const file = $('#upload_file')[0].files[0];
            const lostfoundtype_id = $('#addCategory').val();
            const type = op;
            const timeVal = $('#addTime').val();
            const stick = $('#addIsTop').val();

            if (!file) return window.Toast.error("请选择物品图片");

            // 构造JSON数据
            const itemData = {
                title: $('#addForm [name="title"]').val().trim(),
                place: $('#addForm [name="place"]').val().trim(),
                phone: $('#addForm [name="phone"]').val().trim(),
                content: $('#addForm [name="content"]').val().trim(),
                state: '待审核',
                user_id: 1,
                lostfoundtype_id: lostfoundtype_id,
                type: type,
                pub_date: timeVal ? new Date(timeVal).getTime() : new Date().getTime(),
                stick: stick
            };

            const formData = new FormData();
            formData.append('upload_file', file);
            formData.append('op', op);

            if (op === '失物') {
                formData.append('lostJson', JSON.stringify(itemData));
                formData.append('foundJson', "");
            } else {
                formData.append('foundJson', JSON.stringify(itemData));
                formData.append('lostJson', "");
            }

            $.ajax({
                url: '/school/addLostFound',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(res) {
                    if (res && res.status === 0) {
                        window.Toast.success("发布成功！请等待审核");
                        bootstrap.Modal.getInstance('#addModal').hide();
                        loadData(1);
                    } else {
                        window.Toast.error(res?.msg || "发布失败");
                    }
                },
                error: function() {
                    window.Toast.error("服务器响应异常");
                }
            });
        };

    })();
</script>