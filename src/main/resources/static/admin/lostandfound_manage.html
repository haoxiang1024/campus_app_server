<link href="./css/sweetalert2.min.css" rel="stylesheet">
<style>
    .content-wrapper {
        background: #ffffff !important;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        padding: 25px;
        margin: 15px;
        color: #333 !important;
    }
    .text-custom-blue { color: #00aaff !important; }
    .table-light th { background-color: #f8f9fa !important; color: #666 !important; font-weight: 600; }
    .btn-outline-custom { color: #00aaff !important; border-color: #dee2e6 !important; }
    .btn-outline-custom:hover:not(:disabled) { background-color: #00aaff !important; color: white !important; }
    .btn-outline-custom:disabled { cursor: not-allowed; opacity: 0.5; }
    .detail-img-wrapper { text-align: center; padding: 15px; background: #fdfdfd; border: 1px dashed #dee2e6; border-radius: 8px; margin-top: 10px; }
    .detail-img { max-height: 250px; max-width: 100%; border-radius: 4px; cursor: zoom-in; }
    .btn-link { text-decoration: none !important; }
    .form-select-sm { border-color: #dee2e6 !important; color: #666; }
</style>

<div class="content-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-4 gap-3 flex-wrap">
        <div class="d-flex gap-2">
            <button class="btn btn-outline-success btn-sm" id="batchApproveBtn">批量通过</button>
            <button class="btn btn-outline-warning btn-sm" id="batchRejectBtn">批量驳回</button>
            <button class="btn btn-outline-danger btn-sm" id="batchDeleteBtn">批量删除</button>
            <button class="btn btn-warning btn-sm text-white px-3" onclick="openAddModal()">+ 登记信息</button>
        </div>
        <div class="d-flex gap-2">
            <select id="typeFilter" class="form-select form-select-sm" style="width: 100px;">
                <option value="">所有类型</option>
                <option value="失物">失物</option>
                <option value="招领">招领</option>
            </select>
            <select id="stateFilter" class="form-select form-select-sm" style="width: 110px;">
                <option value="">所有状态</option>
                <option value="待审核">待审核</option>
                <option value="寻找中">寻找中</option>
                <option value="待认领">待认领</option>
                <option value="已驳回">已驳回</option>
            </select>
            <div class="input-group input-group-sm" style="width: 250px;">
                <input type="text" id="searchInput" class="form-control" placeholder="搜索名称/地点/联系电话...">
                <button class="btn btn-primary" type="button" id="searchBtn">
                    <i class="fa fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th style="width: 45px;"><input type="checkbox" id="selectAll" class="form-check-input"></th>
                <th style="width: 80px;">类型</th>
                <th>物品名称</th>
                <th>地点</th>
                <th>发布时间</th>
                <th>联系电话</th>
                <th>状态</th>
                <th class="text-center">操作</th>
            </tr>
            </thead>
            <tbody id="lostTableBody">
            <tr><td colspan="8" class="text-center text-muted">正在检索数据...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="d-flex flex-column align-items-center mt-4" id="paginationWrapper">
        <div class="d-flex align-items-center gap-3">
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLostFirstPage">首页</button>
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLostPrevPage">上一页</button>
            </div>
            <span id="lostPageInfo" class="text-custom-blue fw-bold">第 1 页 / 共 1 页</span>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLostNextPage">下一页</button>
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLostLastPage">末页</button>
            </div>
        </div>
        <div class="mt-2 text-muted small">共 <span id="lostTotalCount">0</span> 条记录</div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-custom-blue">信息详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-0" id="detailContent"></div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-custom-blue">信息登记</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">发布类型</label>
                            <select class="form-select" name="op" id="addOp" required>
                                <option value="丢失">失物登记 (我丢了东西)</option>
                                <option value="招领">招领登记 (我捡了东西)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">物品名称</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">地点</label>
                            <input type="text" class="form-control" name="place" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">联系电话</label>
                            <input type="text" class="form-control" name="phone" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">详细描述</label>
                            <textarea class="form-control" name="content" rows="3"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">上传图片</label>
                            <input type="file" class="form-control" name="upload_file" id="upload_file" accept="image/*" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitRegistration()">立即发布</button>
            </div>
        </div>
    </div>
</div>
<script src="./js/jquery.min.js"></script>
<script src="./js/bootstrap.bundle.min.js"></script>
<script src="./js/sweetalert2@11.js"></script>

<script>
    // 统一定制 Toast 提示
    window.Toast = window.Toast || {
        success: (msg) => {
            Swal.fire({ icon: 'success', title: msg, toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, width: '220px', padding: '0.5rem' });
        },
        error: (msg) => {
            Swal.fire({ icon: 'error', title: '操作失败', text: msg, confirmButtonColor: '#00aaff', width: '320px' });
        },
        confirm: (title, text, callback) => {
            Swal.fire({ title: title, text: text, icon: 'warning', showCancelButton: true, confirmButtonColor: '#00aaff', cancelButtonColor: '#6c757d', confirmButtonText: '确定', cancelButtonText: '取消' }).then((result) => { if (result.isConfirmed) callback(); });
        },
        prompt: (title, placeholder, callback) => {
            Swal.fire({
                title: title,
                input: 'text',
                inputPlaceholder: placeholder,
                showCancelButton: true,
                confirmButtonColor: '#00aaff',
                confirmButtonText: '提交',
                cancelButtonText: '取消',
                inputValidator: (value) => { if (!value) return '请务必填写原因！' }
            }).then((result) => { if (result.isConfirmed) callback(result.value); });
        }
    };

    (function() {
        let currentLostPage = 1;
        let totalLostPages = 1;
        const pageSize = 10;
        let allData = []; // 当前页数据缓存

        function formatDate(ts) {
            if (!ts) return '未设置';
            const d = new Date(ts);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        // 加载数据
        function loadData(page) {
            currentLostPage = page;
            const keyword = $('#searchInput').val().trim();
            const state = $('#stateFilter').val();
            const type = $('#typeFilter').val();

            $('#lostTableBody').html('<tr><td colspan="8" class="text-center text-muted">正在检索最新数据...</td></tr>');

            $.get('/school/admin/getLostFoundByPage', {
                page: page,
                pageSize: pageSize,
                keyword: keyword,
                state: state,
                type: type
            }, function(res) {
                if(res.status === 0 && res.data) {
                    allData = res.data.list || [];
                    const totalItems = res.data.total || 0;
                    totalLostPages = res.data.totalPages || 1;
                    console.log(res.data)

                    renderLostTable(allData);

                    $('#lostPageInfo').text(`第 ${currentLostPage} 页 / 共 ${totalLostPages} 页`);
                    $('#lostTotalCount').text(totalItems);
                    $('#btnLostFirstPage, #btnLostPrevPage').prop('disabled', currentLostPage <= 1);
                    $('#btnLostNextPage, #btnLostLastPage').prop('disabled', currentLostPage >= totalLostPages);
                    $('#selectAll').prop('checked', false);
                } else {
                    $('#lostTableBody').html('<tr><td colspan="8" class="text-center text-danger">数据加载失败</td></tr>');
                }
            });
        }

        // 渲染表格
        function renderLostTable(data) {
            let html = '';
            if (!data.length) {
                html = '<tr><td colspan="8" class="text-center text-muted">未找到匹配的记录</td></tr>';
            } else {
                data.forEach(item => {
                    let typeBadge = item.type === '招领'
                        ? '<span class="badge border text-success border-success">招领</span>'
                        : '<span class="badge border text-danger border-danger">失物</span>';

                    let badgeClass = 'bg-secondary';
                    if(item.state === '待审核') badgeClass = 'bg-info';
                    else if(item.state === '寻找中') badgeClass = 'bg-primary';
                    else if(item.state === '已认领') badgeClass = 'bg-success';
                    else if(item.state === '已驳回') badgeClass = 'bg-danger';

                    let btns = `<button class="btn btn-sm btn-link text-custom-blue p-0 me-2" onclick="showLostDetail(${item.id})">详情</button>`;
                    if(item.state === '待审核') {
                        btns += `<button class="btn btn-sm btn-link text-success p-0 me-2 fw-bold" onclick="approveSingle(${item.id})">通过</button>`;
                        btns += `<button class="btn btn-sm btn-link text-warning p-0 me-2 fw-bold" onclick="rejectSingle(${item.id})">驳回</button>`;
                    }
                    btns += `<button class="btn btn-sm btn-link text-danger p-0" onclick="deleteItem(${item.id})">删除</button>`;

                    html += `<tr>
                        <td><input type="checkbox" class="item-checkbox form-check-input" value="${item.id}"></td>
                        <td>${typeBadge}</td>
                        <td class="fw-bold">${item.title}</td>
                        <td>${item.place}</td>
                        <td><small class="text-muted">${formatDate(item.pubDate)}</small></td>
                        <td>${item.phone || '-'}</td>
                        <td><span class="badge ${badgeClass} text-white">${item.state}</span></td>
                        <td class="text-center">${btns}</td>
                    </tr>`;
                });
            }
            $('#lostTableBody').html(html);
        }

        $('#batchApproveBtn').on('click', function() {
            //获取选中的 ID
            const selectedIds = $('.item-checkbox:checked').map(function() { return $(this).val(); }).get();
            if (!selectedIds.length) return window.Toast.error('请先勾选项目');

            //从本地缓存 allData 中过滤出真正属于“待审核”状态的项
            const targetItems = allData.filter(item =>
                selectedIds.includes(item.id.toString()) && item.state === '待审核'
            );

            if (targetItems.length === 0) {
                return window.Toast.error('选中的记录中没有待审核的项');
            }

            //弹出确认框
            window.Toast.confirm('批量通过', `确定要审核通过这 ${targetItems.length} 条记录吗？`, () => {
                //构建并发请求数组
                const promises = targetItems.map(item => {
                    const targetState = (item.type === '失物') ? '寻找中' : '待认领';

                    return $.post('/school/admin/updateLostFoundStatus', {
                        lostFoundId: item.id,
                        state: targetState
                    });
                });

                Promise.all(promises).then(results => {
                    // 统计执行成功的数量
                    const successCount = results.filter(res => res.status === 0).length;

                    if (successCount === targetItems.length) {
                        window.Toast.success(`批量操作成功，共处理 ${successCount} 条记录`);
                    } else {
                        window.Toast.success(`操作完成：${successCount} 条成功，${targetItems.length - successCount} 条失败`);
                    }

                    // 重新加载当前页数据以刷新表格状态
                    loadData(currentLostPage);
                }).catch(err => {
                    window.Toast.error("网络异常，批量请求未能全部完成");
                    console.error(err);
                });
            });
        });

        $('#batchRejectBtn').on('click', function() {
            // 获取选中的 ID 数组
            const selectedIds = $('.item-checkbox:checked').map(function() { return $(this).val(); }).get();
            if (!selectedIds.length) return window.Toast.error('请先勾选项目');

            //  过滤出真正可以被驳回的项（只有“待审核”状态的才行）
            const targetIds = [];
            let skipCount = 0;
            selectedIds.forEach(id => {
                const item = allData.find(u => u.id == id);
                if (item && item.state === '待审核') {
                    targetIds.push(id);
                } else {
                    skipCount++;
                }
            });

            if (!targetIds.length) return window.Toast.error('选中项中没有符合驳回条件（待审核）的记录');

            //  提示输入原因
            const title = skipCount > 0 ? `批量驳回 (将跳过 ${skipCount} 项)` : '批量驳回';
            window.Toast.prompt(title, '请输入统一的驳回原因', (reason) => {

                //  构建并发请求：循环调用单条接口
                const promises = targetIds.map(id => {
                    return $.post('/school/admin/updateLostFoundStatus', {
                        lostFoundId: id,
                        state: '已驳回',
                        reason: reason
                    });
                });

                // 执行并处理结果
                Promise.all(promises).then(results => {
                    const successCount = results.filter(res => res.status === 0).length;
                    window.Toast.success(`操作完成：成功驳回 ${successCount} 条记录`);
                    loadData(currentLostPage); // 刷新当前页
                }).catch(err => {
                    window.Toast.error("部分请求失败，请检查网络");
                    loadData(currentLostPage);
                });
            });
        });

        // 批量删除
        $('#batchDeleteBtn').on('click', function() {
            const selectedIds = $('.item-checkbox:checked').map(function() { return $(this).val(); }).get();
            if (!selectedIds.length) return window.Toast.error('请勾选要删除的项目');

            window.Toast.confirm("批量删除", `确定永久删除选中的 ${selectedIds.length} 项记录吗？`, () => {
                const promises = selectedIds.map(id => {
                    return $.post('/school/admin/deleteLostFoundById', { lostFoundId: id });
                });
                Promise.all(promises).then(() => {
                    window.Toast.success("删除操作完成");
                    loadData(1); // 删除后建议回到第一页
                }).catch(err => {
                    window.Toast.error("部分请求失败");
                    loadData(currentLostPage);
                });
            });
        });


        window.approveSingle = (id) => {
            // 从缓存中获取当前项的数据以判断类型
            const item = allData.find(u => u.id == id);
            if (!item) return;

            // 根据类型决定目标状态
            const targetState = item.type === '失物' ? '寻找中' : '待认领';

            window.Toast.confirm('审核通过', `确认将该${item.type}信息发布为“${targetState}”吗？`, () => {
                $.post('/school/admin/updateLostFoundStatus', {
                    lostFoundId: id,
                    state: targetState  // 使用动态计算的状态
                }, (res) => {
                    if(res.status === 0) {
                        window.Toast.success("已发布");
                        loadData(currentLostPage);
                    }
                });
            });
        };

        window.rejectSingle = (id) => {
            window.Toast.prompt('审核驳回', '说明驳回理由', (reason) => {
                $.post('/school/admin/updateLostFoundStatus', { lostFoundId: id, state: '已驳回', reason: reason }, (res) => {
                    if(res.status === 0) { window.Toast.success("已驳回"); loadData(currentLostPage); }
                });
            });
        };

        window.showLostDetail = (id) => {
            $.get('/school/admin/getLostFoundById', { lostFoundId: id, _t: new Date().getTime() }, function(res) {
                if(res.status === 0 && res.data) {
                    const item = res.data;
                    const typeLabel = item.type === '招领' ? '招领' : '失物';
                    const content = `
                        <div class="mb-2"><strong>类型：</strong>${typeLabel}</div>
                        <div class="mb-2"><strong>标题：</strong>${item.title}</div>
                        <div class="mb-2"><strong>地点：</strong>${item.place}</div>
                        <div class="mb-3"><strong>详情：</strong>${item.content || '无'}</div>
                        <div class="detail-img-wrapper">
                            <img src="${item.img || './images/no-image.png'}" class="detail-img" onclick="window.open(this.src)">
                        </div>`;
                    $('#detailContent').html(content);
                    new bootstrap.Modal('#detailModal').show();
                }
            });
        };

        window.deleteItem = (id) => {
            window.Toast.confirm("删除确认", "确定永久删除此信息吗？", () => {
                $.post('/school/admin/deleteLostFoundById', { lostFoundId: id }, (res) => {
                    if(res.status === 0) { window.Toast.success("已删除"); loadData(currentLostPage); }
                });
            });
        };

        //事件监听

        $('#searchBtn').on('click', () => loadData(1));
        $('#searchInput').on('keypress', e => { if(e.which === 13) loadData(1); });
        $('#stateFilter, #typeFilter').on('change', () => loadData(1));
        $('#selectAll').on('change', function() { $('.item-checkbox').prop('checked', this.checked); });

        $('#btnLostFirstPage').on('click', () => loadData(1));
        $('#btnLostLastPage').on('click', () => loadData(totalLostPages));
        $('#btnLostPrevPage').on('click', () => { if(currentLostPage > 1) loadData(currentLostPage - 1); });
        $('#btnLostNextPage').on('click', () => { if(currentLostPage < totalLostPages) loadData(currentLostPage + 1); });

        // 首次加载
        loadData(1);

        // 打开登记弹窗
        window.openAddModal = () => {
            $('#addForm')[0].reset();
            new bootstrap.Modal('#addModal').show();
        };

// 提交登记信息
        window.submitRegistration = () => {
            const op = $('#addOp').val();
            const file = $('#upload_file')[0].files[0];

            if (!file) return window.Toast.error("请选择物品图片");

            // 构造 JSON 数据
            const itemData = {
                title: $('#addForm [name="title"]').val(),
                place: $('#addForm [name="place"]').val(),
                phone: $('#addForm [name="phone"]').val(),
                content: $('#addForm [name="content"]').val(),
                state: '待审核' // 默认初始状态
            };

            const formData = new FormData();
            formData.append('upload_file', file);
            formData.append('op', op);

            // 根据 op 字段将 JSON 放入不同的参数名中
            if (op === '丢失') {
                formData.append('lostJson', JSON.stringify(itemData));
                formData.append('foundJson', ""); // 占位
            } else {
                formData.append('foundJson', JSON.stringify(itemData));
                formData.append('lostJson', ""); // 占位
            }

            $.ajax({
                url: '/school/admin/addLostFound',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(res) {
                    if (res.status === 0) {
                        window.Toast.success("发布成功！请等待审核");
                        bootstrap.Modal.getInstance('#addModal').hide();
                        loadData(1); // 刷新列表
                    } else {
                        window.Toast.error(res.msg || "发布失败");
                    }
                },
                error: function() {
                    window.Toast.error("服务器响应异常");
                }
            });
        };

    })();
</script>