<link href="./css/sweetalert2.min.css" rel="stylesheet">
<style>
    .content-wrapper {
        background: #ffffff !important;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        padding: 25px;
        margin: 15px;
        color: #333 !important;
    }
    .text-custom-blue { color: #00aaff !important; }
    .table-light th { background-color: #f8f9fa !important; color: #666 !important; font-weight: 600; }
    .btn-outline-custom { color: #00aaff !important; border-color: #dee2e6 !important; }
    .btn-outline-custom:hover:not(:disabled) { background-color: #00aaff !important; color: white !important; }
    .detail-img-wrapper { text-align: center; padding: 15px; background: #fdfdfd; border: 1px dashed #dee2e6; border-radius: 8px; margin-top: 10px; }
    .detail-img { max-height: 250px; max-width: 100%; border-radius: 4px; cursor: zoom-in; }
    /* 去掉链接按钮的下划线 */
    .btn-link { text-decoration: none !important; }
</style>

<div class="content-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-4 gap-3">
        <div class="d-flex gap-2">
            <button class="btn btn-outline-success btn-sm" id="batchApproveBtn">批量通过</button>
            <button class="btn btn-outline-danger btn-sm" id="batchDeleteBtn">批量删除</button>
            <button class="btn btn-warning btn-sm text-white px-3" onclick="openAddModal()">+ 登记信息</button>
        </div>
        <div class="input-group input-group-sm" style="width: 280px;">
            <input type="text" id="searchInput" class="form-control" placeholder="搜索物品名称/地点/联系人...">
            <button class="btn btn-primary" type="button" id="searchBtn">
                <i class="fa fa-search"></i>
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th style="width: 45px;"><input type="checkbox" id="selectAll" class="form-check-input"></th>
                <th>物品名称</th>
                <th>丢失地点</th>
                <th>发布时间</th>
                <th>联系电话</th>
                <th>状态</th>
                <th class="text-center">操作</th>
            </tr>
            </thead>
            <tbody id="lostTableBody">
            <tr><td colspan="7" class="text-center text-muted">正在检索数据...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="d-flex flex-column align-items-center mt-4" id="paginationWrapper">
        <div class="d-flex align-items-center gap-3">
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLostFirstPage">首页</button>
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLostPrevPage">上一页</button>
            </div>
            <span id="lostPageInfo" class="text-custom-blue fw-bold">第 1 页 / 共 1 页</span>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLostNextPage">下一页</button>
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLostLastPage">末页</button>
            </div>
        </div>
        <div class="mt-2 text-muted small">共 <span id="lostTotalCount">0</span> 条记录</div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-custom-blue">信息详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-0" id="detailContent"></div>
            <div class="modal-footer border-top-0"><button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">关闭</button></div>
        </div>
    </div>
</div>

<script src="./js/sweetalert2@11.js"></script>

<script>
    window.Toast = window.Toast || {
        success: (msg) => {
            Swal.fire({ icon: 'success', title: msg, toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, width: '220px', padding: '0.5rem' });
        },
        error: (msg) => {
            Swal.fire({ icon: 'error', title: '操作失败', text: msg, confirmButtonColor: '#00aaff', width: '320px' });
        },
        confirm: (title, text, callback) => {
            Swal.fire({ title: title, text: text, icon: 'warning', showCancelButton: true, confirmButtonColor: '#00aaff', cancelButtonColor: '#6c757d', confirmButtonText: '确定', cancelButtonText: '取消' }).then((result) => { if (result.isConfirmed) callback(); });
        }
    };

    (function() {
        let currentLostPage = 1;
        let totalLostPages = 1;
        const pageSize = 10;

        function formatDate(ts) {
            if (!ts) return '未设置';
            const d = new Date(ts);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }
        let lostKeyword = ""; // 新增变量存储关键字
        // 分页模式加载数据
        function loadLostData(page) {
            currentLostPage = page;
            lostKeyword = $('#searchLostInput').val() || ""; // 获取搜索框内容

            $.get('/school/admin/getLostList', {
                page: page,
                pageSize: 10,
                keyword: lostKeyword
            }, function(res) {
                if(res.status === 0) {
                    renderLostTable(res.data.list);
                    renderPagination(res.data.totalPages, res.data.total);
                }
            });
        }

        // 新增：搜索函数（调用 getAllLost 接口）
        function doSearchLost() {
            const keyword = $('#searchInput').val().trim();
            // 如果搜索内容为空，则自动切回正常分页模式
            if (!keyword) {
                loadLostData(1);
                return;
            }

            $('#lostTableBody').html('<tr><td colspan="7" class="text-center text-muted">正在搜索相关数据...</td></tr>');

            $.ajax({
                url: '/school/admin/getAllLost',
                type: 'GET',
                cache: false,
                data: { keyword: keyword, _t: new Date().getTime() },
                success: function(res) {
                    if (res.status === 0 && res.data) {
                        renderLostTable(res.data);
                        $('#paginationWrapper').hide(); // 搜索结果通常为全量展示，隐藏分页控件
                        $('#lostTotalCount').text(res.data.length); // 更新总数显示
                    } else {
                        $('#lostTableBody').html('<tr><td colspan="7" class="text-center text-muted">未找到匹配的检索结果</td></tr>');
                        $('#lostTotalCount').text(0);
                    }
                },
                error: () => window.Toast.error("搜索接口响应异常")
            });
        }

        function renderLostTable(data) {
            let html = data.length ? '' : '<tr><td colspan="7" class="text-center text-muted">暂无数据</td></tr>';
            data.forEach(item => {
                let badgeClass = item.state === '待审核' ? 'bg-info' : (item.state === '已找到' ? 'bg-success' : 'bg-warning');
                let btns = `<button class="btn btn-sm btn-link text-custom-blue p-0 me-2" onclick="showLostDetail(${item.id})">详情</button>`;
                if(item.state === '待审核') {
                    btns += `<button class="btn btn-sm btn-link text-success p-0 me-2" onclick="updateLostStatus(${item.id}, '未找到')">通过</button>`;
                }
                btns += `<button class="btn btn-sm btn-link text-danger p-0" onclick="deleteLostItem(${item.id})">删除</button>`;

                html += `<tr>
                <td><input type="checkbox" class="item-checkbox form-check-input" value="${item.id}"></td>
                <td class="fw-bold">${item.title}</td>
                <td>${item.place}</td>
                <td><small class="text-muted">${formatDate(item.pubDate)||'-'}</small></td>
                <td>${item.phone || '-'}</td>
                <td><span class="badge ${badgeClass} text-white">${item.state}</span></td>
                <td class="text-center">${btns}</td>
            </tr>`;
            });
            $('#lostTableBody').html(html);
        }

        function updatePaginationUI(total) {
            $('#lostTotalCount').text(total);
            totalLostPages = Math.ceil(total / pageSize) || 1;
            $('#lostPageInfo').text(`第 ${currentLostPage} 页 / 共 ${totalLostPages} 页`);
            $('#btnLostFirstPage, #btnLostPrevPage').prop('disabled', currentLostPage === 1);
            $('#btnLostNextPage, #btnLostLastPage').prop('disabled', currentLostPage === totalLostPages);
        }

        // 事件绑定
        $('#btnLostFirstPage').off().on('click', () => loadLostData(1));
        $('#btnLostLastPage').off().on('click', () => loadLostData(totalLostPages));
        $('#btnLostPrevPage').off().on('click', () => { if(currentLostPage > 1) loadLostData(currentLostPage - 1); });
        $('#btnLostNextPage').off().on('click', () => { if(currentLostPage < totalLostPages) loadLostData(currentLostPage + 1); });

        // 搜索按钮绑定新函数
        $('#searchBtn').off().on('click', doSearchLost);
        // 回车键支持搜索
        $('#searchInput').off().on('keypress', e => { if(e.which === 13) doSearchLost(); });

        $('#selectAll').off().on('change', function() { $('.item-checkbox').prop('checked', $(this).is(':checked')); });

        // 批量操作与全局函数保持不变
        $('#batchApproveBtn').off().on('click', function() {
            const ids = $('.item-checkbox:checked').map(function() { return $(this).val(); }).get();
            if (!ids.length) return window.Toast.error('请先勾选');
            $.post('/school/admin/batchUpdateStatus', { ids: ids.join(','), state: '未找到' }, (res) => {
                if(res.status === 0) { window.Toast.success("操作成功"); loadLostData(currentLostPage); }
            });
        });

        $('#batchDeleteBtn').off().on('click', function() {
            const ids = $('.item-checkbox:checked').map(function() { return $(this).val(); }).get();
            if (!ids.length) return window.Toast.error('请选择项目');
            window.Toast.confirm("批量删除", `确定删除选中的 ${ids.length} 项吗？`, () => {
                $.post('/school/admin/batchDeleteLost', { ids: ids.join(',') }, (res) => {
                    if(res.status === 0) { window.Toast.success("删除成功"); loadLostData(1); }
                });
            });
        });

        window.showLostDetail = (id) => {
            $.get('/school/admin/getLostById', { lostId: id, _t: new Date().getTime() }, function(res) {
                if(res.status === 0 && res.data) {
                    const item = res.data;
                    const content = `<div class="mb-2"><strong>标题：</strong>${item.title}</div><div class="mb-2"><strong>地点：</strong>${item.place}</div><div class="mb-3"><strong>详情：</strong>${item.content || '无'}</div><div class="detail-img-wrapper"><img src="${item.img || './images/no-image.png'}" class="detail-img" onclick="window.open(this.src)"></div>`;
                    $('#detailContent').html(content);
                    new bootstrap.Modal('#detailModal').show();
                }
            });
        };

        window.updateLostStatus = (id, state) => {
            $.post('/school/admin/updateLostStatus', { lostId: id, state: state }, (res) => {
                if(res.status === 0) { window.Toast.success("已通过"); loadLostData(currentLostPage); }
            });
        };

        window.deleteLostItem = (id) => {
            window.Toast.confirm("删除确认", "确定永久删除此信息吗？", () => {
                $.post('/school/admin/deleteLost', { lostId: id }, (res) => {
                    if(res.status === 0) { window.Toast.success("已删除"); loadLostData(currentLostPage); }
                });
            });
        };

        // 默认进入页面加载分页模式
        loadLostData(1);
    })();
</script>