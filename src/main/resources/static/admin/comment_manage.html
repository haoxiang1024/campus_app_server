<link href="./css/sweetalert2.min.css" rel="stylesheet">
<style>
    .content-wrapper {
        background: #ffffff !important;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        padding: 25px;
        margin: 15px;
        color: #333 !important;
    }
    .text-custom-blue { color: #00aaff !important; }
    .table-light th { background-color: #f8f9fa !important; color: #666 !important; font-weight: 600; }
    .btn-outline-custom { color: #00aaff !important; border-color: #dee2e6 !important; }
    .btn-outline-custom:hover:not(:disabled) { background-color: #00aaff !important; color: white !important; }
    .btn-outline-custom:disabled { cursor: not-allowed; opacity: 0.5; }
    .btn-link { text-decoration: none !important; }
    .form-select-sm { border-color: #dee2e6 !important; color: #666; }
    .comment-content { max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
</style>

<div class="content-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-4 gap-3 flex-wrap ">
        <div class="d-flex gap-2">
            <button class="btn btn-outline-success btn-sm" id="batchApproveBtn">批量通过</button>
            <button class="btn btn-outline-warning btn-sm" id="batchRejectBtn">批量驳回</button>
            <button class="btn btn-outline-danger btn-sm" id="batchDeleteBtn">批量删除</button>
        </div>
        <div class="d-flex gap-2">
            <select id="stateFilter" class="form-select form-select-sm" style="width: 120px;">
                <option value="" selected>所有状态</option>
                <option value="0">待审核</option>
                <option value="1">已通过</option>
                <option value="2">已驳回</option>
            </select>
            <div class="input-group input-group-sm" style="width: 260px;">
                <input type="text" id="searchInput" class="form-control" placeholder="搜索评论内容/评论人/帖子...">
                <button class="btn btn-primary" type="button" id="searchBtn" >
                    <i class="fa fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th style="width: 45px;"><input type="checkbox" id="selectAll" class="form-check-input"></th>
                <th style="width: 25%;">评论内容</th>
                <th>评论人</th>
                <th>关联帖子标题</th>
                <th>发布时间</th>
                <th>状态</th>
                <th class="text-center">操作</th>
            </tr>
            </thead>
            <tbody id="commentTableBody">
            <tr><td colspan="7" class="text-center text-muted">正在检索数据...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="d-flex flex-column align-items-center mt-4" id="paginationWrapper">
        <div class="d-flex align-items-center gap-3">
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-custom px-3" id="btnFirstPage">首页</button>
                <button class="btn btn-sm btn-outline-custom px-3" id="btnPrevPage">上一页</button>
            </div>
            <span id="pageInfo" class="text-custom-blue fw-bold">第 1 页 / 共 1 页</span>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-custom px-3" id="btnNextPage">下一页</button>
                <button class="btn btn-sm btn-outline-custom px-3" id="btnLastPage">末页</button>
            </div>
        </div>
        <div class="mt-2 text-muted small">共 <span id="totalCount">0</span> 条记录</div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-custom-blue">评论详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-0" id="detailContent"></div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<script src="./js/jquery.min.js"></script>
<script src="./js/bootstrap.bundle.min.js"></script>
<script src="./js/sweetalert2@11.js"></script>

<script>
    // 统一定制 Toast 提示
    window.Toast = window.Toast || {
        success: (msg) => { Swal.fire({ icon: 'success', title: msg, toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, width: '220px', padding: '0.5rem' }); },
        error: (msg) => { Swal.fire({ icon: 'error', title: '操作失败', text: msg, confirmButtonColor: '#00aaff', width: '320px' }); },
        confirm: (title, text, callback) => { Swal.fire({ title: title, text: text, icon: 'warning', showCancelButton: true, confirmButtonColor: '#00aaff', cancelButtonColor: '#6c757d', confirmButtonText: '确定', cancelButtonText: '取消' }).then((result) => { if (result.isConfirmed) callback(); }); },
        prompt: (title, placeholder, callback) => { Swal.fire({ title: title, input: 'text', inputPlaceholder: placeholder, showCancelButton: true, confirmButtonColor: '#00aaff', confirmButtonText: '提交', cancelButtonText: '取消', inputValidator: (value) => { if (!value) return '请务必填写原因！' } }).then((result) => { if (result.isConfirmed) callback(result.value); }); }
    };

    (function() {
        let currentPage = 1;
        let totalPages = 1;
        const pageSize = 10;
        let allData = [];

        function formatDate(ts) {
            if (!ts) return '-';
            const d = new Date(ts);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        // 加载评论数据
        function loadData(page) {
            currentPage = page;
            const keyword = $('#searchInput').val().trim();
            const state = $('#stateFilter').val();

            $('#commentTableBody').html('<tr><td colspan="7" class="text-center text-muted">正在检索最新数据...</td></tr>');

            $.get('/school/admin/getCommentsByPage', {
                page: page,
                pageSize: pageSize,
                keyword: keyword,
                state: state
            }, function(res) {
                if(res.status === 0 && res.data) {
                    allData = res.data.list || [];
                    const totalItems = res.data.total || 0;
                    totalPages = res.data.totalPages || 1;

                    renderTable(allData);

                    $('#pageInfo').text(`第 ${currentPage} 页 / 共 ${totalPages} 页`);
                    $('#totalCount').text(totalItems);
                    $('#btnFirstPage, #btnPrevPage').prop('disabled', currentPage <= 1);
                    $('#btnNextPage, #btnLastPage').prop('disabled', currentPage >= totalPages);
                    $('#selectAll').prop('checked', false);
                } else {
                    $('#commentTableBody').html('<tr><td colspan="7" class="text-center text-danger">数据加载失败</td></tr>');
                }
            });
        }

        // 渲染表格
        function renderTable(data) {
            let html = '';
            if (!data.length) {
                html = '<tr><td colspan="7" class="text-center text-muted">未找到匹配的记录</td></tr>';
            } else {
                data.forEach(item => {
                    let badgeClass = 'bg-secondary';
                    let stateText = item.state; // 默认值

                    // 数字转换为字符显示
                    if(item.state == 0) {
                        badgeClass = 'bg-info';
                        stateText = '待审核';
                    } else if(item.state == 1) {
                        badgeClass = 'bg-success';
                        stateText = '已通过';
                    } else if(item.state == 2) {
                        badgeClass = 'bg-danger';
                        stateText = '已驳回';
                    }

                    let btns = `<button class="btn btn-sm btn-link text-custom-blue p-0 me-2" onclick="showDetail(${item.id})">详情</button>`;
                    if(item.state == 0) {
                        btns += `<button class="btn btn-sm btn-link text-success p-0 me-2 fw-bold" onclick="updateStatus(${item.id}, '已通过')">通过</button>`;
                        btns += `<button class="btn btn-sm btn-link text-warning p-0 me-2 fw-bold" onclick="updateStatus(${item.id}, '已驳回')">驳回</button>`;
                    }
                    btns += `<button class="btn btn-sm btn-link text-danger p-0" onclick="deleteItem(${item.id})">删除</button>`;

                    html += `<tr>
                        <td><input type="checkbox" class="item-checkbox form-check-input" value="${item.id}"></td>
                        <td><div class="comment-content" title="${item.content}">${item.content}</div></td>
                        <td>${item.nickname || '-'}</td>
                        <td class="text-muted">${item.title || '-'}</td>
                        <td><small class="text-muted">${formatDate(item.create_time)}</small></td>
                        <td><span class="badge ${badgeClass} text-white">${stateText}</span></td>
                        <td class="text-center">${btns}</td>
                    </tr>`;
                });
            }
            $('#commentTableBody').html(html);
        }

        // 批量操作通用函数
        function batchOperate(targetStateText, confirmTitle, successMsg, requireReason = false) {
            const selectedIds = $('.item-checkbox:checked').map(function() { return $(this).val(); }).get();
            if (!selectedIds.length) return window.Toast.error('请先勾选项目');

            // 判断使用 == 0，兼容数字和字符串
            const targetItems = allData.filter(item => selectedIds.includes(item.id.toString()) && item.state == 0);
            if (targetItems.length === 0) return window.Toast.error('选中的记录中没有可处理的【待审核】项');

            const stateCode = targetStateText === '已通过' ? 1 : 2;

            const executeBatch = (reason = '') => {
                const promises = targetItems.map(item => $.post('/school/admin/updateCommentStatus', {
                    commentId: item.id,
                    state: stateCode,
                    reason: reason
                }));

                Promise.all(promises).then(results => {
                    const successCount = results.filter(res => res.status === 0).length;
                    window.Toast.success(`${successMsg}：成功 ${successCount} 条`);
                    loadData(currentPage);
                }).catch(() => {
                    window.Toast.error("部分请求失败，请检查网络");
                    loadData(currentPage);
                });
            };

            if (requireReason) {
                window.Toast.prompt(confirmTitle, '请输入统一的驳回原因', executeBatch);
            } else {
                window.Toast.confirm(confirmTitle, `确定要将这 ${targetItems.length} 条记录标记为【${targetStateText}】吗？`, executeBatch);
            }
        }

        $('#batchApproveBtn').on('click', () => batchOperate('已通过', '批量通过', '审核通过', false));
        $('#batchRejectBtn').on('click', () => batchOperate('已驳回', '批量驳回', '已驳回', true));

        // 批量删除
        $('#batchDeleteBtn').on('click', function() {
            const selectedIds = $('.item-checkbox:checked').map(function() { return $(this).val(); }).get();
            if (!selectedIds.length) return window.Toast.error('请勾选要删除的项目');

            window.Toast.confirm("批量删除", `确定永久删除选中的 ${selectedIds.length} 条评论吗？`, () => {
                const promises = selectedIds.map(id => $.post('/school/admin/deleteCommentById', { commentId: id }));
                Promise.all(promises).then(() => {
                    window.Toast.success("删除操作完成");
                    loadData(1);
                }).catch(() => {
                    window.Toast.error("部分请求失败");
                    loadData(currentPage);
                });
            });
        });

        // 单个审核操作 (通过/驳回)
        window.updateStatus = (id, state) => {
            if (state === '已驳回') {
                window.Toast.prompt('审核驳回', '说明驳回理由（可选）', (reason) => {
                    sendUpdateRequest(id, state, reason);
                });
            } else {
                window.Toast.confirm('审核通过', '确认通过该评论吗？', () => {
                    sendUpdateRequest(id, state, '');
                });
            }
        };

        function sendUpdateRequest(id, stateText, reason) {
            const stateCode = stateText === '已通过' ? 1 : 2;

            $.ajax({
                url: '/school/admin/updateCommentStatus',
                type: 'POST',
                data: {
                    commentId: id,
                    state: stateCode,
                    reason: reason
                },
                success: (res) => {
                    if(res.status === 0) {
                        window.Toast.success(`已${stateText}`);
                        loadData(currentPage);
                    } else {
                        window.Toast.error(res.msg || "操作失败");
                    }
                },
                error: () => {
                    window.Toast.error("请求失败，请检查参数或网络");
                }
            });
        }

        // 单个删除
        window.deleteItem = (id) => {
            window.Toast.confirm("删除确认", "确定永久删除此评论吗？", () => {
                $.post('/school/admin/deleteCommentById', { commentId: id }, (res) => {
                    if(res.status === 0) { window.Toast.success("已删除"); loadData(currentPage); }
                });
            });
        };

        // 查看详情
        window.showDetail = (id) => {
            const item = allData.find(u => u.id == id);
            if (!item) return;

            // 详情弹窗中的状态映射
            let stateText = '未知状态';
            let badgeClass = 'bg-secondary';
            if (item.state == 0) { stateText = '待审核'; badgeClass = 'bg-info'; }
            else if (item.state == 1) { stateText = '已通过'; badgeClass = 'bg-success'; }
            else if (item.state == 2) { stateText = '已驳回'; badgeClass = 'bg-danger'; }

            const content = `
                <div class="mb-2"><strong>评论人：</strong>${item.nickname || '未知用户'}</div>
                <div class="mb-2"><strong>关联帖子：</strong>${item.title || '未知帖子'}</div>
                <div class="mb-2"><strong>发布时间：</strong>${formatDate(item.create_time)}</div>
                <div class="mb-2"><strong>当前状态：</strong>
                    <span class="badge ${badgeClass}">${stateText}</span>
                </div>
                ${item.rejectReason ? `<div class="mb-2 text-danger"><strong>驳回原因：</strong>${item.rejectReason}</div>` : ''}
                <hr>
                <div class="mb-3"><strong>评论全文：</strong><br><p class="mt-2 text-break" style="background: #f8f9fa; padding: 10px; border-radius: 6px;">${item.content || '无内容'}</p></div>
            `;
            $('#detailContent').html(content);
            new bootstrap.Modal('#detailModal').show();
        };

        // 事件监听
        $('#searchBtn').on('click', () => loadData(1));
        $('#searchInput').on('keypress', e => { if(e.which === 13) loadData(1); });
        $('#stateFilter').on('change', () => loadData(1));
        $('#selectAll').on('change', function() { $('.item-checkbox').prop('checked', this.checked); });

        $('#btnFirstPage').on('click', () => loadData(1));
        $('#btnLastPage').on('click', () => loadData(totalPages));
        $('#btnPrevPage').on('click', () => { if(currentPage > 1) loadData(currentPage - 1); });
        $('#btnNextPage').on('click', () => { if(currentPage < totalPages) loadData(currentPage + 1); });

        // 初始化加载（默认加载待审核状态，已在 HTML 静态绑定）
        loadData(1);

    })();
</script>