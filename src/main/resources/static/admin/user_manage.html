<link href="./css/sweetalert2.min.css" rel="stylesheet">

<style>

    .text-custom-blue { color: #00aaff !important; }
    .btn-outline-custom {
        color: #00aaff !important;
        border-color: #00aaff !important;
    }
    .btn-outline-custom:hover {
        background-color: #00aaff !important;
        color: white !important;
    }
    .btn-link.text-custom-blue {
        color: #00aaff !important;
        text-decoration: none;
    }
    .btn-link.text-custom-blue:hover {
        color: #0088cc !important;
    }
    .modal-content { border-radius: 12px; border: none; }
    #avatarPreview {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #00aaff;
        margin-bottom: 10px;
    }
    /* 开关颜色自定义 */
    .form-check-input:checked {
        background-color: #00aaff;
        border-color: #00aaff;
    }
    /* 批量操作按钮布局优化 */
    .batch-actions {
        min-width: 280px;
    }
</style>

<div class="animation-fadeIn">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <h4 class="m-0 text-custom-blue me-4">用户账号管理</h4>
            <div class="batch-actions d-flex gap-2">
                <button class="btn btn-sm btn-outline-success px-3" id="btnBatchEnable">批量启用</button>
                <button class="btn btn-sm btn-outline-warning px-3" id="btnBatchDisable">批量禁用</button>
            </div>
        </div>

        <div class="input-group" style="max-width: 380px; flex-shrink: 0;">
            <input type="text" id="userKeyword" class="form-control border-end-0 border-secondary" placeholder="搜索(昵称/手机号/email),为空则显示所有">
            <button class="btn btn-outline-custom border-start-0" type="button" id="btnSearchUser">
                <i class="fa fa-search"></i>
            </button>
        </div>
    </div>

    <div class="table-card" style="border-radius: 12px; padding: 20px;">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll" class="form-check-input"></th>
                    <th>ID</th><th>头像</th><th>昵称</th>
                    <th class="text-center">性别</th>
                    <th>注册时间</th><th>手机号码</th><th>状态</th><th>操作</th>
                </tr>
                </thead>
                <tbody id="userTableBody">
                <tr><td colspan="9" class="text-center">加载中...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between mt-3" id="paginationBar">
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-custom" id="btnFirstPage">首页</button>
                <button class="btn btn-sm btn-outline-custom" id="btnPrevPage">上一页</button>
            </div>
            <span id="pageInfo" class="align-self-center text-custom-blue fw-bold">第 1 页 / 共 1 页</span>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-custom" id="btnNextPage">下一页</button>
                <button class="btn btn-sm btn-outline-custom" id="btnLastPage">末页</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered " style="max-width: 400px;max-height: 600px;" >
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-custom-blue">编辑用户信息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm" enctype="multipart/form-data">
                    <input type="hidden" name="id" id="editUserId">
                    <div class="mb-3 text-center">
                        <div><img src="" id="avatarPreview" onerror="this.src='./svgs/solid/circle-user.svg'"></div>
                        <label for="editPhoto" class="btn btn-sm btn-outline-secondary">更换头像</label>
                        <input type="file" id="editPhoto" name="photoFile" accept="image/*" style="display: none;">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">昵称</label>
                        <input type="text" class="form-control" name="nickname" id="editNickname">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">性别</label>
                        <select class="form-select" name="sex" id="editSex">
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">手机号码</label>
                        <input type="text" class="form-control" name="phone" id="editPhone" maxlength="11">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" id="editEmail">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="btnSubmitEdit" style="background-color: #00aaff; border: none;">保存修改</button>
            </div>
        </div>
    </div>
</div>

<script src="./js/sweetalert2@11.js"></script>

<script>
    (function() {
        let currentPage = 1;
        let totalPages = 1;
        const pageSize = 10;
        let allUsersData = [];

        // 美化弹窗工具封装
        const Toast = {
            // 成功提示（右上角自动消失）
            success: (msg) => {
                Swal.fire({
                    icon: 'success',
                    title: msg,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    width: '220px', // 强制宽度
                    padding: '0.5rem', // 极简内边距
                });
            },
            // 错误/失败提示（中间弹窗）
            error: (msg) => {
                Swal.fire({
                    icon: 'error',
                    title: '操作失败',
                    text: msg,
                    confirmButtonColor: '#00aaff',
                    width: '320px', // 锁定宽度，不再显得巨大
                    padding: '1.25rem',
                    customClass: {
                        title: 'fs-6', // 使用 Bootstrap 字体类缩小标题
                        htmlContainer: 'small' // 缩小内容字体
                    }
                });
            },
            // 确认对话框
            confirm: (title, text, callback) => {
                Swal.fire({
                    title: title,
                    text: text,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#00aaff',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    width: '350px', // 确认框稍宽一点点以便容纳两个按钮
                    padding: '1.25rem',
                    customClass: {
                        title: 'fs-6',
                        htmlContainer: 'small'
                    }
                }).then((result) => {
                    if (result.isConfirmed) callback();
                });
            }
        };

        function getPhotoUrl(photo) {
            if (!photo) return './svgs/solid/circle-user.svg';
            if (photo.startsWith('http')) return photo;
            return '/school/upload/' + photo;
        }

        function formatDate(ts) {
            if (!ts) return '未设置';
            const d = new Date(ts);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        function renderUserTable(list) {
            allUsersData = list;
            const $tbody = $('#userTableBody');
            if (!list || list.length === 0) {
                $tbody.html('<tr><td colspan="9" class="text-center text-muted">暂无匹配的数据</td></tr>');
                return;
            }
            let html = '';
            list.forEach(u => {
                const isChecked = u.status === 1 ? 'checked' : '';
                html += `<tr>
                <td><input type="checkbox" class="form-check-input user-checkbox" value="${u.id}"></td>
                <td>${u.id}</td>
                <td><img src="${getPhotoUrl(u.photo)}" style="width:35px;height:35px;border-radius:50%;object-fit:cover;" onerror="this.src='./svgs/solid/circle-user.svg'"></td>
                <td>${u.nickname || '未设置'}</td>
                <td class="text-center">${u.sex || '-'}</td>
                <td><small class="text-muted">${formatDate(u.reg_date)}</small></td>
                <td>${u.phone || '-'}</td>
                <td>
                    <div class="form-check form-switch">
                        <input class="form-check-input status-switch" type="checkbox" data-id="${u.id}" ${isChecked}>
                    </div>
                </td>
                <td>
                    <button class="btn btn-sm btn-link text-custom-blue p-0 btn-edit-user" data-id="${u.id}"><i class="fa fa-edit"></i></button>
                </td>
            </tr>`;
            });
            $tbody.html(html);

            $('.status-switch').off('change').on('change', function() {
                const id = $(this).data('id');
                const status = this.checked ? 1 : 0;
                updateUserStatus([id], status);
            });

            $('.btn-edit-user').off('click').on('click', function() {
                const id = $(this).data('id');
                const user = allUsersData.find(item => item.id == id);
                if (user) {
                    $('#editUserId').val(user.id);
                    $('#editNickname').val(user.nickname || '');
                    $('#editSex').val(user.sex || '男');
                    $('#editPhone').val(user.phone || '');
                    $('#editEmail').val(user.email || '');
                    $('#avatarPreview').attr('src', getPhotoUrl(user.photo));
                    $('#editPhoto').val('');
                    $('#editUserModal').modal('show');
                }
            });
        }

        function updateUserStatus(ids, status) {
            $.post('/school/admin/updateUserStatus', { ids: ids.join(','), status: status }, function(res) {
                if (res.status === 0) {
                    Toast.success('状态更新成功');
                    loadUsers(currentPage);
                } else {
                    Toast.error(res.msg);
                    loadUsers(currentPage);
                }
            });
        }

        $('#editPhoto').on('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => $('#avatarPreview').attr('src', e.target.result);
                reader.readAsDataURL(file);
            }
        });

        function loadUsers(page) {
            $.get(`/school/admin/getAllUserInfo`, { page: page, size: pageSize }, function(res) {
                if (res.status === 0) {
                    const list = res.data.list || [];
                    const total = res.data.total || 0;
                    totalPages = Math.ceil(total / pageSize) || 1;
                    currentPage = page;
                    renderUserTable(list);
                    $('#pageInfo').text(`第 ${currentPage} 页 / 共 ${totalPages} 页`);
                    $('#btnFirstPage, #btnPrevPage').prop('disabled', currentPage === 1);
                    $('#btnNextPage, #btnLastPage').prop('disabled', currentPage === totalPages);
                    $('#selectAll').prop('checked', false);
                    $('#paginationBar').show();
                }
            });
        }

        $('#btnSubmitEdit').on('click', function() {
            const nickname = $('#editNickname').val().trim();
            const phone = $('#editPhone').val().trim();
            const email = $('#editEmail').val().trim();

            if (!nickname) { Toast.error('昵称不能为空'); return; }
            if (!phone) { Toast.error('手机号不能为空'); return; }
            if (!email) { Toast.error('Email 不能为空'); return; }
            if (!/^\d{11}$/.test(phone)) { Toast.error('请输入11位手机号'); return; }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { Toast.error('Email格式不正确'); return; }

            const formData = new FormData(document.getElementById('editUserForm'));
            $.ajax({
                url: '/school/admin/updateUserInfo',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(res) {
                    if (res.status === 0) {
                        $('#editUserModal').modal('hide');
                        Toast.success('用户信息修改成功');
                        loadUsers(currentPage);
                    } else {
                        Toast.error(res.msg);
                    }
                }
            });
        });

        $('#selectAll').on('change', function() { $('.user-checkbox').prop('checked', this.checked); });

        $('#btnBatchEnable').on('click', function() {
            const ids = $('.user-checkbox:checked').map((i, el) => el.value).get();
            if (ids.length === 0) { Toast.error('请先选择用户'); return; }
            Toast.confirm('确认启用', `确认启用选中的 ${ids.length} 个账号吗？`, () => updateUserStatus(ids, 1));
        });

        $('#btnBatchDisable').on('click', function() {
            const ids = $('.user-checkbox:checked').map((i, el) => el.value).get();
            if (ids.length === 0) { Toast.error('请先选择用户'); return; }
            Toast.confirm('确认禁用', `确认禁用选中的 ${ids.length} 个账号吗？`, () => updateUserStatus(ids, 0));
        });

        function doSearch() {
            const kw = $('#userKeyword').val().trim();
            if (!kw) { loadUsers(1); return; }
            $.get('/school/admin/searchUsers', { keyword: kw }, function(res) {
                if (res.status === 0) {
                    renderUserTable(res.data);
                    $('#pageInfo').text(`搜索结果: ${res.data.length} 条`);
                    $('#paginationBar').hide();
                }
            });
        }

        $('#btnSearchUser').on('click', doSearch);
        $('#userKeyword').on('keypress', e => { if(e.which===13) doSearch(); });
        $('#btnFirstPage').on('click', () => loadUsers(1));
        $('#btnLastPage').on('click', () => loadUsers(totalPages));
        $('#btnPrevPage').on('click', () => { if(currentPage > 1) loadUsers(currentPage - 1); });
        $('#btnNextPage').on('click', () => { if(currentPage < totalPages) loadUsers(currentPage + 1); });

        loadUsers(1);
    })();
</script>